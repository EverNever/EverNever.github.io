<!DOCTYPE html><html lang="zh-CN"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>Airflow源码分析(1)-executor部分 | chace</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=0.0.0"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/7.0.0/normalize.min.css"><link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="https://unpkg.com/purecss@1.0.0/build/grids-responsive-min.css"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">Airflow源码分析(1)-executor部分</h1><a id="logo" href="/.">chace</a><p class="description"></p></div><div id="nav-menu"><a href="/." class="current"><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div id="layout" class="pure-g"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">Airflow源码分析(1)-executor部分</h1><div class="post-meta">Sep 1, 2019<script src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><div class="post-content"><h2 id="Executor简介"><a href="#Executor简介" class="headerlink" title="Executor简介"></a>Executor简介</h2><p>Executor是在scheduler和worker之间的一个组件，主要作用是接收scheduler发过来的可执行task，然后根据自身类型决定task的运行环境。</p>
<p>目前有四种类型：</p>
<ol>
<li>SequentialExecutor：Dag在单进程中顺序执行，用于测试跟开发</li>
<li>LocalExecutor：Dag在本地多进程执行，也是用于测试跟开发</li>
<li>CeleryExecutor：通过Celery下发任务到分布式集群。</li>
<li>DaskExecutor：下发任务到Dask集群上执行。Dask不支持队列。</li>
</ol>
<h2 id="流程分析"><a href="#流程分析" class="headerlink" title="流程分析"></a>流程分析</h2><p>scheduler经过各种验证以后，终于将task标记为queued状态。</p>
<p>接下来，scheduler调用executor.queue_command将task_instance交给实际的executor。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">self.executor.queue_command(simple_task_instance, command, priority=priority, queue=queue)</div></pre></td></tr></table></figure>
<h3 id="BaseExecutor"><a href="#BaseExecutor" class="headerlink" title="BaseExecutor"></a>BaseExecutor</h3><p>我们打开<code>base_executor.py</code>，这个文件中<code>BaseExecutor</code>类作为具体executor的基类，可以看出executor大概的一个流程。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># 两个任务队列和一个事件buffer都是dict类型的，key是task_id</span></div><div class="line">        self.queued_tasks = OrderedDict()</div><div class="line">        self.running = &#123;&#125;</div><div class="line">        self.event_buffer = &#123;&#125;</div><div class="line"></div><div class="line"><span class="comment"># 这个方法就是上面scheduler调用的方法，可以看出，BaseExecutor里维护了queued_tasks的任务队列，在这个方法里将新的task加入到了queued_tasks中</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">queue_command</span><span class="params">(self, simple_task_instance, command, priority=<span class="number">1</span>, queue=None)</span>:</span></div><div class="line">        key = simple_task_instance.key</div><div class="line">        <span class="keyword">if</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.queued_tasks <span class="keyword">and</span> key <span class="keyword">not</span> <span class="keyword">in</span> self.running:</div><div class="line">            self.log.info(<span class="string">"Adding to queue: %s"</span>, command)</div><div class="line">            self.queued_tasks[key] = (command, priority, queue, simple_task_instance)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            self.log.info(<span class="string">"could not queue task %s"</span>, key)</div><div class="line"></div><div class="line"><span class="comment"># scheduler会在自身的心跳间隔中重复调用executor.heartbeat()</span></div><div class="line"><span class="comment"># heartbeat()方法中，除了会打印executor的状态外，还会调用trigger_task()触发任务和sync()来同步状态</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">heartbeat</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="comment"># Triggering new jobs</span></div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> self.parallelism:</div><div class="line">            open_slots = len(self.queued_tasks)</div><div class="line">        <span class="keyword">else</span>:</div><div class="line">            open_slots = self.parallelism - len(self.running)</div><div class="line"></div><div class="line">        num_running_tasks = len(self.running)</div><div class="line">        num_queued_tasks = len(self.queued_tasks)</div><div class="line"></div><div class="line">        self.log.debug(<span class="string">"%s running task instances"</span>, num_running_tasks)</div><div class="line">        self.log.debug(<span class="string">"%s in queue"</span>, num_queued_tasks)</div><div class="line">        self.log.debug(<span class="string">"%s open slots"</span>, open_slots)</div><div class="line"></div><div class="line">        Stats.gauge(<span class="string">'executor.open_slots'</span>, open_slots)</div><div class="line">        Stats.gauge(<span class="string">'executor.queued_tasks'</span>, num_queued_tasks)</div><div class="line">        Stats.gauge(<span class="string">'executor.running_tasks'</span>, num_running_tasks)</div><div class="line"></div><div class="line">        self.trigger_tasks(open_slots)</div><div class="line"></div><div class="line">        <span class="comment"># Calling child class sync method</span></div><div class="line">        self.log.debug(<span class="string">"Calling the %s sync method"</span>, self.__class__)</div><div class="line">        self.sync()</div><div class="line"></div><div class="line"><span class="comment"># 在trigger_tasks()方法中，最终会调用execute_async()方法来执行命令</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">trigger_tasks</span><span class="params">(self, open_slots)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Trigger tasks</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param open_slots: Number of open slots</span></div><div class="line"><span class="string">        :return:</span></div><div class="line"><span class="string">        """</span></div><div class="line">        sorted_queue = sorted(</div><div class="line">            [(k, v) <span class="keyword">for</span> k, v <span class="keyword">in</span> self.queued_tasks.items()],</div><div class="line">            key=<span class="keyword">lambda</span> x: x[<span class="number">1</span>][<span class="number">1</span>],</div><div class="line">            reverse=<span class="keyword">True</span>)</div><div class="line">        <span class="keyword">for</span> i <span class="keyword">in</span> range(min((open_slots, len(self.queued_tasks)))):</div><div class="line">            key, (command, _, queue, simple_ti) = sorted_queue.pop(<span class="number">0</span>)</div><div class="line">            self.queued_tasks.pop(key)</div><div class="line">            self.running[key] = command</div><div class="line">            self.execute_async(key=key,</div><div class="line">                               command=command,</div><div class="line">                               queue=queue,</div><div class="line">                               executor_config=simple_ti.executor_config)</div><div class="line"></div><div class="line"><span class="comment"># sync()和execute_async()都是抽象方法，但是从注释中我们可以看出其作用</span></div><div class="line"><span class="comment"># sync()用于收集状态，execute_async()是异步执行命令</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">sync</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Sync will get called periodically by the heartbeat method.</span></div><div class="line"><span class="string">        Executors should override this to perform gather statuses.</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">execute_async</span><span class="params">(self,</span></span></div><div class="line"><span class="function"><span class="params">                      key,</span></span></div><div class="line"><span class="function"><span class="params">                      command,</span></span></div><div class="line"><span class="function"><span class="params">                      queue=None,</span></span></div><div class="line"><span class="function"><span class="params">                      executor_config=None)</span>:</span>  <span class="comment"># pragma: no cover</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        This method will execute the command asynchronously.</span></div><div class="line"><span class="string">        """</span></div><div class="line">        <span class="keyword">raise</span> NotImplementedError()</div><div class="line"></div><div class="line"><span class="comment"># change_state(...)只会改变event_buffer中的事件状态，但不会真正改变task的状态。</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">change_state</span><span class="params">(self, key, state)</span>:</span></div><div class="line">        self.log.debug(<span class="string">"Changing state: %s"</span>, key)</div><div class="line">        self.running.pop(key, <span class="keyword">None</span>)</div><div class="line">        self.event_buffer[key] = state</div></pre></td></tr></table></figure>
<p>总结一下executor的功能：</p>
<ol>
<li>接收来自scheduler的task，加入到自身维护的queued_tasks中</li>
<li>在接收到scheduler的心跳后，打印自身的一些状态，在trigger_tasks(…)中将task从queued_tasks转移到running中，并最终调用execute_async(…)异步执行命令并调用sync(…)收集状态</li>
<li>scheduler可以调用get_event_buffer(…)获取executor的事件。executor改变自身维护的queued_tasks和running队列中task的状态时，都会上报事件到event_buffer中，从而可以被scheduler获取到</li>
</ol>
<h3 id="SequentialExecutor"><a href="#SequentialExecutor" class="headerlink" title="SequentialExecutor"></a>SequentialExecutor</h3><p>接下来以SequentialExecutor为例，看下execute_async和sync具体是怎么实现的</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">execute_async</span><span class="params">(self, key, command, queue=None, executor_config=None)</span>:</span></div><div class="line">    self.commands_to_run.append((key, command,))</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">sync</span><span class="params">(self)</span>:</span></div><div class="line">    <span class="keyword">for</span> key, command <span class="keyword">in</span> self.commands_to_run:</div><div class="line">        self.log.info(<span class="string">"Executing command: %s"</span>, command)</div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="comment"># 在这里启动了一个子进程来执行task对应的command</span></div><div class="line">            subprocess.check_call(command, close_fds=<span class="keyword">True</span>)</div><div class="line">            <span class="comment"># 阻塞等待子进程返回，然偶上报success或者failed的状态</span></div><div class="line">            self.change_state(key, State.SUCCESS)</div><div class="line">        <span class="keyword">except</span> subprocess.CalledProcessError <span class="keyword">as</span> e:</div><div class="line">            self.change_state(key, State.FAILED)</div><div class="line">            self.log.error(<span class="string">"Failed to execute task %s."</span>, str(e))</div><div class="line"></div><div class="line">    self.commands_to_run = []</div></pre></td></tr></table></figure>
<p><strong>那么，task的调用到这里就结束了吗？</strong></p>
<p>一个<code>subprocess.check_call(command, close_fds=True)</code>就完了？task本身的状态是在哪改变的？对于HttpOperator，这个command又是如何执行的？</p>
<p>眉头一皱，发现事情并没有那么简单。</p>
<p>这里的command具体是什么呢？通过日志我们可以看到，其实是调用airflow CLI的run命令。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="number">2019</span>-<span class="number">07</span>-<span class="number">04</span> <span class="number">15</span>:<span class="number">42</span>:<span class="number">25</span>,<span class="number">046</span>] &#123;base_executor.py:<span class="number">59</span>&#125; INFO - Adding to queue: ['airflow', 'run', 'example_json', 'echo_env', '<span class="number">2019-07-04</span>T07:42:24.<span class="number">824155</span>+00:00', '--local']</div></pre></td></tr></table></figure></p>
<h3 id="cli-run"><a href="#cli-run" class="headerlink" title="cli.run"></a>cli.run</h3><p>继续来看cli.run()</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># run()中加载了配置文件，获取dag并实例化了TaskInstance，最终调用了_run()方法</span></div><div class="line"><span class="meta">@cli_utils.action_logging</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(args, dag=None)</span>:</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    task = dag.get_task(task_id=args.task_id)</div><div class="line">    ti = TaskInstance(task, args.execution_date)</div><div class="line">    ti.refresh_from_db()</div><div class="line"></div><div class="line">    ti.init_run_context(raw=args.raw)</div><div class="line"></div><div class="line">    hostname = get_hostname()</div><div class="line">    log.info(<span class="string">"Running %s on host %s"</span>, ti, hostname)</div><div class="line"></div><div class="line">    <span class="keyword">if</span> args.interactive:</div><div class="line">        _run(args, dag, ti)</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        <span class="keyword">with</span> redirect_stdout(ti.log, logging.INFO), redirect_stderr(ti.log, logging.WARN):</div><div class="line">            _run(args, dag, ti)</div><div class="line">    logging.shutdown()</div><div class="line"></div><div class="line"><span class="comment"># _run()方法中会根据参数来选择合适的，根据之前的参数'--local'，我们会进入到LocalTaskJob中去</span></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">_run</span><span class="params">(args, dag, ti)</span>:</span></div><div class="line">    <span class="keyword">if</span> args.local:</div><div class="line">        run_job = jobs.LocalTaskJob(</div><div class="line">            task_instance=ti,</div><div class="line">            mark_success=args.mark_success,</div><div class="line">            pickle_id=args.pickle,</div><div class="line">            ignore_all_deps=args.ignore_all_dependencies,</div><div class="line">            ignore_depends_on_past=args.ignore_depends_on_past,</div><div class="line">            ignore_task_deps=args.ignore_dependencies,</div><div class="line">            ignore_ti_state=args.force,</div><div class="line">            pool=args.pool)</div><div class="line">        run_job.run()</div><div class="line">    <span class="keyword">elif</span> args.raw:</div><div class="line">        ti._run_raw_task(</div><div class="line">            mark_success=args.mark_success,</div><div class="line">            job_id=args.job_id,</div><div class="line">            pool=args.pool,</div><div class="line">        )</div><div class="line">    <span class="keyword">else</span>:</div><div class="line">        pickle_id = <span class="keyword">None</span></div><div class="line">        <span class="keyword">if</span> args.ship_dag:</div><div class="line">        <span class="comment"># ...</span></div></pre></td></tr></table></figure>
<p>接下来是<code>base_job.py</code>，<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div></pre></td><td class="code"><pre><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        Stats.incr(self.__class__.__name__.lower() + <span class="string">'_start'</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line">        <span class="comment"># Adding an entry in the DB</span></div><div class="line">        <span class="keyword">with</span> create_session() <span class="keyword">as</span> session:</div><div class="line">            self.state = State.RUNNING</div><div class="line">            session.add(self)</div><div class="line">            session.commit()</div><div class="line">            id_ = self.id</div><div class="line">            make_transient(self)</div><div class="line">            self.id = id_</div><div class="line"></div><div class="line">            <span class="keyword">try</span>:</div><div class="line">                self._execute()</div><div class="line">                <span class="comment"># In case of max runs or max duration</span></div><div class="line">                self.state = State.SUCCESS</div><div class="line">            <span class="keyword">except</span> SystemExit:</div><div class="line">                <span class="comment"># In case of ^C or SIGTERM</span></div><div class="line">                self.state = State.SUCCESS</div><div class="line">            <span class="keyword">except</span> Exception:</div><div class="line">                self.state = State.FAILED</div><div class="line">                <span class="keyword">raise</span></div><div class="line">            <span class="keyword">finally</span>:</div><div class="line">                self.end_date = timezone.utcnow()</div><div class="line">                session.merge(self)</div><div class="line">                session.commit()</div><div class="line"></div><div class="line">        Stats.incr(self.__class__.__name__.lower() + <span class="string">'_end'</span>, <span class="number">1</span>, <span class="number">1</span>)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_execute</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">raise</span> NotImplementedError(<span class="string">"This method needs to be overridden"</span>)</div><div class="line"></div><div class="line"><span class="comment"># LocalTaskJob中有具体的实现，可以看到是调用了一个TaskRunner</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_execute</span><span class="params">(self)</span>:</span></div><div class="line">        self.task_runner = get_task_runner(self)</div><div class="line">        <span class="comment"># 省略...</span></div><div class="line">        self.task_runner.start()</div><div class="line"></div><div class="line"><span class="comment"># 接下来跳转到StandardTaskRunner</span></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">StandardTaskRunner</span><span class="params">(BaseTaskRunner)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line"><span class="string">    Runs the raw Airflow task by invoking through the Bash shell.</span></div><div class="line"><span class="string">    """</span></div><div class="line">    <span class="comment"># ...</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">start</span><span class="params">(self)</span>:</span></div><div class="line">        self.process = self.run_command()</div><div class="line">    <span class="comment"># ...</span></div><div class="line"></div><div class="line"><span class="comment"># 然后是run_command的具体实现</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_command</span><span class="params">(self, run_with=None, join_args=False)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Run the task command.</span></div><div class="line"><span class="string"></span></div><div class="line"><span class="string">        :param run_with: list of tokens to run the task command with e.g. ``['bash', '-c']``</span></div><div class="line"><span class="string">        :type run_with: list</span></div><div class="line"><span class="string">        :param join_args: whether to concatenate the list of command tokens e.g. ``['airflow', 'run']`` vs</span></div><div class="line"><span class="string">            ``['airflow run']``</span></div><div class="line"><span class="string">        :param join_args: bool</span></div><div class="line"><span class="string">        :return: the process that was run</span></div><div class="line"><span class="string">        :rtype: subprocess.Popen</span></div><div class="line"><span class="string">        """</span></div><div class="line">        run_with = run_with <span class="keyword">or</span> []</div><div class="line">        cmd = [<span class="string">" "</span>.join(self._command)] <span class="keyword">if</span> join_args <span class="keyword">else</span> self._command</div><div class="line">        full_cmd = run_with + cmd</div><div class="line"></div><div class="line">        self.log.info(<span class="string">'Running: %s'</span>, full_cmd)</div><div class="line">        proc = subprocess.Popen(</div><div class="line">            full_cmd,</div><div class="line">            stdout=subprocess.PIPE,</div><div class="line">            stderr=subprocess.STDOUT,</div><div class="line">            universal_newlines=<span class="keyword">True</span>,</div><div class="line">            close_fds=<span class="keyword">True</span>,</div><div class="line">            env=os.environ.copy(),</div><div class="line">            preexec_fn=os.setsid</div><div class="line">        )</div><div class="line"></div><div class="line">        <span class="comment"># Start daemon thread to read subprocess logging output</span></div><div class="line">        log_reader = threading.Thread(</div><div class="line">            target=self._read_task_logs,</div><div class="line">            args=(proc.stdout,),</div><div class="line">        )</div><div class="line">        log_reader.daemon = <span class="keyword">True</span></div><div class="line">        log_reader.start()</div><div class="line">        <span class="keyword">return</span> proc</div></pre></td></tr></table></figure></p>
<p>代码看到这里发现又是subprocess.Popen(cmd)，那么这个时候的cmd内容是什么呢？可以从日志中看到。<br><figure class="highlight 1c"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">[<span class="number">2019</span>-<span class="number">07</span>-<span class="number">04</span> <span class="number">13</span>:<span class="number">15</span>:<span class="number">38</span>,<span class="number">406</span>] &#123;base_task_runner.py:<span class="number">133</span>&#125; INFO - Running: ['airflow', 'run', 'example_json', 'echo_env', '<span class="number">2019-07-04</span>T05:15:36.<span class="number">239140</span>+00:00', '--job_id', '120', '--raw', '--cfg_path', '/tmp/tmpg<span class="number">2123</span>epz']</div></pre></td></tr></table></figure></p>
<p>会发现又是airflow run，但是这个时候的cmd参数更多了，而且有一个<code>--raw</code>的参数。</p>
<h3 id="TaskInstance-run-raw-task"><a href="#TaskInstance-run-raw-task" class="headerlink" title="TaskInstance._run_raw_task"></a>TaskInstance._run_raw_task</h3><p>回到<code>_run(...)</code>，这个时候再执行命令会去另一个分支。于是会执行：<br><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line"><span class="comment"># cli.py</span></div><div class="line">    <span class="keyword">elif</span> args.raw:</div><div class="line">        ti._run_raw_task(</div><div class="line">            mark_success=args.mark_success,</div><div class="line">            job_id=args.job_id,</div><div class="line">            pool=args.pool,</div><div class="line">        )</div><div class="line"></div><div class="line"><span class="comment"># taskinstance.py</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">_run_raw_task</span><span class="params">(</span></span></div><div class="line"><span class="function"><span class="params">            self,</span></span></div><div class="line"><span class="function"><span class="params">            mark_success=False,</span></span></div><div class="line"><span class="function"><span class="params">            test_mode=False,</span></span></div><div class="line"><span class="function"><span class="params">            job_id=None,</span></span></div><div class="line"><span class="function"><span class="params">            pool=None,</span></span></div><div class="line"><span class="function"><span class="params">            session=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line"><span class="string">        Immediately runs the task (without checking or changing db state</span></div><div class="line"><span class="string">        before execution) and then sets the appropriate final state after</span></div><div class="line"><span class="string">        completion and runs any post-execute callbacks. Meant to be called</span></div><div class="line"><span class="string">        only after another function changes the state to running.</span></div><div class="line"><span class="string">        """</span></div><div class="line"></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">        <span class="comment"># ...</span></div><div class="line"></div><div class="line">        <span class="comment"># 这里的task_copy类型就是Operator，也就是我们再定义DAG的时候选择的具体操作，通过调用Operator.execute(...)真正执行了我们想要运行的操作</span></div><div class="line">                task_copy.pre_execute(context=context)</div><div class="line">        <span class="comment"># ...</span></div><div class="line">                    result = task_copy.execute(context=context)</div><div class="line">        <span class="comment"># ...</span></div><div class="line">                task_copy.post_execute(context=context, result=result)</div><div class="line">        <span class="comment"># ...</span></div><div class="line">            self.refresh_from_db(lock_for_update=<span class="keyword">True</span>)</div><div class="line">            self.state = State.SUCCESS</div><div class="line">        <span class="keyword">except</span> AirflowSkipException:</div><div class="line">            self.refresh_from_db(lock_for_update=<span class="keyword">True</span>)</div><div class="line">            self.state = State.SKIPPED</div><div class="line">        <span class="keyword">except</span> AirflowRescheduleException <span class="keyword">as</span> reschedule_exception:</div><div class="line">            self.refresh_from_db()</div><div class="line">            <span class="comment"># 在_handle_reschedule(...)中会将需要reschedule的任务加入到task_reschedule表中，状态为up_for_reschedule，等待被再次调度</span></div><div class="line">            self._handle_reschedule(actual_start_date, reschedule_exception, test_mode, context)</div><div class="line">            <span class="keyword">return</span></div><div class="line">        <span class="keyword">except</span> AirflowException <span class="keyword">as</span> e:</div><div class="line">            self.refresh_from_db()</div><div class="line">            <span class="comment"># for case when task is marked as success/failed externally</span></div><div class="line">            <span class="comment"># current behavior doesn't hit the success callback</span></div><div class="line">            <span class="keyword">if</span> self.state <span class="keyword">in</span> &#123;State.SUCCESS, State.FAILED&#125;:</div><div class="line">                <span class="keyword">return</span></div><div class="line">            <span class="keyword">else</span>:</div><div class="line">            <span class="comment"># 在handle_failure(...)中，会根据重试次数等信息将task状态设为up_for_retry或者failed</span></div><div class="line">                self.handle_failure(e, test_mode, context)</div><div class="line">                <span class="keyword">raise</span></div><div class="line">        <span class="keyword">except</span> (Exception, KeyboardInterrupt) <span class="keyword">as</span> e:</div><div class="line">            self.handle_failure(e, test_mode, context)</div><div class="line">            <span class="keyword">raise</span></div><div class="line"></div><div class="line">        <span class="comment"># Success callback</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            <span class="keyword">if</span> task.on_success_callback:</div><div class="line">                task.on_success_callback(context)</div><div class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e3:</div><div class="line">            self.log.error(<span class="string">"Failed when executing success callback"</span>)</div><div class="line">            self.log.exception(e3)</div><div class="line"></div><div class="line">        <span class="comment"># Recording SUCCESS</span></div><div class="line">        self.end_date = timezone.utcnow()</div><div class="line">        self.set_duration()</div><div class="line">        <span class="keyword">if</span> <span class="keyword">not</span> test_mode:</div><div class="line">            session.add(Log(self.state, self))</div><div class="line">            session.merge(self)</div><div class="line">        session.commit()</div></pre></td></tr></table></figure></p>
<p>到这里，从scheduler将某个task分发给executor开始，一直到task被真正地执行的流程就完成了。</p>
<p>这里只分析了SequentialExecutor，对于CeleryExecutor，只是通过CeleryExecutor将cmd分发到远程worker上面执行了，接下来的流程是一样。</p>
</div><div class="tags"><a href="/tags/Airflow/">Airflow</a><a href="/tags/任务编排调度/">任务编排调度</a></div><div class="post-nav"><a href="/2019/09/01/Airflow源码分析(2)-xcom部分/" class="pre">Airflow源码分析(2)-xcom部分</a><a href="/2019/09/01/Airflow源码分析(0)-介绍/" class="next">Airflow源码分析(0)-介绍</a></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><div class="search-form"><input id="local-search-input" placeholder="Search" type="text" name="q" results="0"/><div id="local-search-result"></div></div></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/Linux/" style="font-size: 15px;">Linux</a> <a href="/tags/Airflow/" style="font-size: 15px;">Airflow</a> <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/分布式系统/" style="font-size: 15px;">分布式系统</a> <a href="/tags/Docker/" style="font-size: 15px;">Docker</a> <a href="/tags/Python/" style="font-size: 15px;">Python</a> <a href="/tags/Go/" style="font-size: 15px;">Go</a> <a href="/tags/任务编排调度/" style="font-size: 15px;">任务编排调度</a> <a href="/tags/数据结构/" style="font-size: 15px;">数据结构</a> <a href="/tags/机器学习/" style="font-size: 15px;">机器学习</a> <a href="/tags/rabbitMQ/" style="font-size: 15px;">rabbitMQ</a> <a href="/tags/kubernetes/" style="font-size: 15px;">kubernetes</a> <a href="/tags/tools/" style="font-size: 15px;">tools</a> <a href="/tags/经验之谈/" style="font-size: 15px;">经验之谈</a> <a href="/tags/段子/" style="font-size: 15px;">段子</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/Airflow源码分析(3)-jinja渲染部分/">Airflow源码分析(3)-jinja渲染部分</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/Airflow源码分析(2)-xcom部分/">Airflow源码分析(2)-xcom部分</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/Airflow源码分析(1)-executor部分/">Airflow源码分析(1)-executor部分</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/Airflow源码分析(0)-介绍/">Airflow源码分析(0)-介绍</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/高可用配置中心etcd/">高可用配置中心etcd</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/09/01/Docker中的namespace和cgroup/">Docker中的namespace和cgroup</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/31/CS6.824(3)-Raft/">CS6.824(3)-Raft</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/31/CS6.824(2)-GFS/">CS6.824(2)-GFS</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/08/30/快速熟悉开源项目(转载)/">快速熟悉开源项目</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/11/Go-tour-3-Concurrency/">Go tour(3)-Concurrency</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://blog.chionlab.moe/" title="ChionLab-未来道具研究所" target="_blank">ChionLab-未来道具研究所</a><ul></ul><a href="http://sinlapis.coding.me/" title="SinLapis的博客" target="_blank">SinLapis的博客</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2019 <a href="/." rel="nofollow">chace.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a id="rocket" href="#top" class="show"></a><script type="text/javascript" src="/js/totop.js?v=0.0.0" async></script><script type="text/javascript" src="/js/search.js?v=0.0.0"></script><script>var search_path = 'search.xml';
if (search_path.length == 0) {
   search_path = 'search.xml';
}
var path = '/' + search_path;
searchFunc(path, 'local-search-input', 'local-search-result');
</script><script type="text/javascript" src="/js/codeblock-resizer.js?v=0.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=0.0.0"></script></div></body></html>